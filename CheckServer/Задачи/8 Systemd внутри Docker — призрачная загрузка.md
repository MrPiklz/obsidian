–¢—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –±–∞–∑–µ ubuntu:22.04, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å systemd, –ø–æ—Ç–æ–º—É —á—Ç–æ:

- —Ç–∞–º –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å–æ–≤  
- —Ö–æ—á–µ—à—å —é–Ω–∏—Ç—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ journalctl –∏ `target`-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–¢—ã –¥–µ–ª–∞–µ—à—å:


FROM ubuntu:22.04
RUN apt update && apt install -y systemd
CMD ["/sbin/init"]


–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ù–æ:

- systemctl –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–≤–∏—Å–∞–µ—Ç –∏–ª–∏ –ø–∞–¥–∞–µ—Ç
- —Å–µ—Ä–≤–∏—Å—ã –Ω–µ —Å—Ç–∞—Ä—Ç—É—é—Ç
- journalctl –≤—ã–¥–∞—ë—Ç: Failed to create /run/systemd/notify: Protocol not supported

–ó–∞–¥–∞—á–∞:  
–û–±—ä—è—Å–Ω–∏, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –ø–æ—á–µ–º—É systemd —Ç–∞–∫ —Å–µ–±—è –≤–µ–¥—ë—Ç –≤–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–ª–∏ –æ–±–æ–π—Ç–∏.

–†–∞–∑–±–æ—Ä:

üîç –ü–æ–¥–≤–æ—Ö ‚Ññ1: Docker –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ init-—Å–µ—Ä–≤–∏—Å–∞

- systemd —Ç—Ä–µ–±—É–µ—Ç PID 1, —Ä–∞–±–æ—Ç—É cgroups, tmpfs, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π init-—Ä–µ–∂–∏–º  
- Docker –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –º–Ω–æ–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω—É–∂–Ω—ã–µ systemd:  
  ‚Ä¢ /sys/fs/cgroup  
  ‚Ä¢ tmpfs /run  
  ‚Ä¢ CAP_SYS_ADMIN  
  ‚Ä¢ --privileged

üõ† –†–µ—à–µ–Ω–∏—è:

1. –î–ª—è –∑–∞–ø—É—Å–∫–∞ systemd inside Docker:  
   –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:

   

   docker run -d --privileged \
     --tmpfs /run --tmpfs /run/lock \
     -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
     myimage:latest
   

2. –õ—É—á—à–µ: –Ω–µ –¥–µ–ª–∞—Ç—å —Ç–∞–∫ –≤–æ–æ–±—â–µ  
   –í–º–µ—Å—Ç–æ systemd ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
   - supervisord, tini, s6-overlay, runit ‚Äî –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π init  
   - –û–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å ‚Äî –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (12-factor rule)  
   - Kubernetes —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º –ª—É—á—à–µ, —á–µ–º systemd

üéØ –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–¥–∞—á–∞:

‚Ä¢ –ü–æ–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ Docker ‚â† VM  
‚Ä¢ –£–º–µ–Ω–∏–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å system-level –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏  
‚Ä¢ –ó–Ω–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤: tini, supervisord, initless Docker  
‚Ä¢ –£–º–µ–Ω–∏–µ –æ–±—ä—è—Å–Ω–∏—Ç—å, –∫–æ–≥–¥–∞ systemd –Ω–µ—É–º–µ—Å—Ç–µ–Ω –≤ DevOps-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ

–•–æ—á–µ—à—å –µ—â—ë —Å–ª–æ–∂–Ω–µ–µ? –ú–æ–∂–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫:

‚Ä¢ race condition –≤ GitLab pipeline  
‚Ä¢ auto rollback —á–µ—Ä–µ–∑ Helm + ArgoCD  
‚Ä¢ —Ö–∞–æ—Å –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ .dockerignore –∏ .dockerfile