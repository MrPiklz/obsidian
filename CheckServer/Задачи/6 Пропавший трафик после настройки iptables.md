–£—Å–ª–æ–≤–∏–µ:

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–æ—Å—Ç–æ–π iptables-—Ñ–∏–ª—å—Ç—Ä –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—Å–µ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞, –∫—Ä–æ–º–µ SSH:


iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT


–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –ø—Ä–∞–≤–∏–ª –≤—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ, —á—Ç–æ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª—ë–Ω–Ω–æ). –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–∏–Ω–≥–∏, –≤—Å—ë –æ–∫.

–ù–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, Docker), –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –µ–≥–æ —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–∞:


docker run -d -p 8080:80 nginx


‚ùóÔ∏è –ü—Ä–æ–±–ª–µ–º–∞: –°–Ω–∞—Ä—É–∂–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –í –±—Ä–∞—É–∑–µ—Ä–µ –∏–ª–∏ curl –ø–æ–ª—É—á–∞–µ—Ç–µ Connection refused. –ù–æ –≤ ss -tlnp –ø–æ—Ä—Ç 8080 –≤–∏–¥–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:


curl http://localhost:8080


‚Äî —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–æ —Å –¥—Ä—É–≥–∏—Ö –º–∞—à–∏–Ω ‚Äî –Ω–µ—Ç.

‚ùì –í–æ–ø—Ä–æ—Å:  
–ü–æ—á–µ–º—É –ø–æ—Ä—Ç 8080 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ? –í —á—ë–º –ø–æ–¥–≤–æ—Ö —Å iptables? –ö–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É?

üîç –ü–æ–¥—Å–∫–∞–∑–∫–∞:

Docker –∏—Å–ø–æ–ª—å–∑—É–µ—Ç nat —Ç–∞–±–ª–∏—Ü—ã –∏ PREROUTING`/`FORWARD —Ü–µ–ø–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ –ø–æ—Ä—Ç–æ–≤.


‚úÖ –†–∞–∑–±–æ—Ä:

üí• –õ–æ–≤—É—à–∫–∞:

–í–∞—à iptables-–ø—Ä–∞–≤–∏–ª–∞:


iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -A INPUT -p tcp --dport 22 -j ACCEPT


–∑–∞–ø—Ä–µ—â–∞—é—Ç –í–°–Å, –∫—Ä–æ–º–µ SSH. –í—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ Docker –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ INPUT, –Ω–æ —ç—Ç–æ –Ω–µ —Ç–∞–∫!

–ö–æ–≥–¥–∞ Docker –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç —Å —Ö–æ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8080), —Å—Ö–µ–º–∞ —Ç–∞–∫–∞—è:

- –í—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ü–µ–ø–æ—á–∫—É PREROUTING (nat)  
- –ü–æ—Ç–æ–º —á–µ—Ä–µ–∑ FORWARD, –µ—Å–ª–∏ –ø–∞–∫–µ—Ç –Ω–µ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω —Ö–æ—Å—Ç—É –Ω–∞–ø—Ä—è–º—É—é, –∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

–ò —Ç—É—Ç –≥–ª–∞–≤–Ω–∞—è –ª–æ–≤—É—à–∫–∞: –¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç –Ω–∞ 0.0.0.0, Docker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–±—Ä–æ—Å —Ç—Ä–∞—Ñ–∏–∫–∞ —á–µ—Ä–µ–∑ FORWARD, –∞ —É –≤–∞—Å –ø–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:


iptables -P FORWARD DROP


–ü–æ—ç—Ç–æ–º—É —Ç—Ä–∞—Ñ–∏–∫ –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ FORWARD.

üîß –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

–ó–∞–ø—É—Å—Ç–∏—Ç—å:


iptables -L -v -n


–í—ã —É–≤–∏–¥–∏—Ç–µ, —á—Ç–æ —Å—á—ë—Ç—á–∏–∫ –ø–∞–∫–µ—Ç–æ–≤ –≤ FORWARD –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä–æ–ø—ã.

üõ† –ö–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å:

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±—Ä–æ—Å–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è Docker:


iptables -A FORWARD -o docker0 -j ACCEPT


–ò–ª–∏ (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ):


iptables -A FORWARD -i eth0 -o docker0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i docker0 -o eth0 -j ACCEPT


‚úÖ –í—ã–≤–æ–¥:

‚Ä¢ –í Linux iptables —Ü–µ–ø–æ—á–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —Å—Ç—Ä–æ–≥–æ–π –ª–æ–≥–∏–∫–µ:  
  - INPUT ‚Äî –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤ –∫ —Ö–æ—Å—Ç—É  
  - FORWARD ‚Äî –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Ö–æ—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã)